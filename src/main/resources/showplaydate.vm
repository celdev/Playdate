#* @vtlvariable name="playdate" type="model.Playdate" *#
<!DOCTYPE html>
<html>
<head>
    <title>Playdate</title>

    #parse("head-links.vm")

    <script>

        $(document).ready(function() {

            $("#post-comment").one(function(e){
                e.preventDefault();
                $("#comment-form").submit();
                $("#popupBasic").popup('close');
            });

            $('.remove-playdate-link').click(function (e) {
                e.preventDefault();
                var playdateid = $(this).data('playdateid');
                var div = $(this).closest('.removeable-playdate-parent');
                console.log("trying to delete playdate with id = " + playdateid);
                $("#popupYes").attr('href','/protected/deleteplaydate?playdateId=' + playdateid)
                $("#popupValidate").popup("open");

            });
            $('#popupYes').click(function (e) {
                console.log("Yes clicked")
                e.preventDefault()
                $.ajax($(this).attr('href'), {
                    type: 'DELETE',
                    success: function(res){
                        window.location.replace("/protected/showplaydates");
                        console.log("success remove playdate");
                        console.log(res)

                    },
                    error: function(res){
                        console.log("failed to remove playdate")
                        console.log(res)
                        alert("Kunde inte ta bort Playdate!")
                    }
                });
            });

            var renderComment = function (comment){
                var output = "<div class='bottom-line'>";
                output += "<p style='font-weight: bold;'><a href='/protected/showuser?userId=" + comment.commenter.id + "'>"  + comment.commenter.name + "</a>" +
                        " "+ comment.commentDate +"</p>"
                output += "<p>" + comment.comment + "</p>"
                output += "</div>"
                $('#show-comments').append(output);
            }

            $('#makeComment').submit(function(e) {
                e.preventDefault();
                e.stopImmediatePropagation();

                $.ajax({
                    type: 'POST',
                    url: '/protected/postcomment',
                    data: $('#makeComment').serialize(),
                    success: function(res) {
                        console.log(res);
                        res = JSON.parse(res);
                        $('#comment').val("");
                        $('#show-comments').html("");
                        $.each(res,function(index, comment) {
                            renderComment(comment)
                        })
                    }
                })
            });
        });
    </script>



</head>
<body>


    #parse("side-panel.vm")

    #parse("header.vm")

    #parse("footer.vm")

<div data-role="page" id="pageone">




    <div data-role="main" class="ui-content">


        <h2>$!{playdate.header}</h2>
        <p style= "margin-top: -1.5em;"> <a data-ajax="false" href="/protected/showplace?placeId=$!{playdate.place.id}"> $!{playdate.place.getName()}</a> </p>
        <p style= "margin-top: -1em;">

            <script>
                var playdateVisibilityType = $!{playdate.PlaydateVisibilityType.getNr()};
                var output;
                switch (playdateVisibilityType) {
                    case 0:
                        output = "Offentlig Playdate";
                        break;
                    case 1:
                        output= "Playdate för vänner";
                        break;
                    case 2:
                        output = "Privat Playdate";
                        break;
                }
                document.write(output);
            </script>
        </p>
        <p style= "margin-top: -1em; font-size: 14px;"> Skapad av <a data-ajax="false" href="/protected/showuser?userId=$!{playdate.owner.id}"> $!{playdate.owner.getName()}</a>

        <div class="ui-grid-a place-image-btns">
            <div class="ui-block-a">
                <img src="/protected/apiimage/$!{playdate.place.getImageId()}" class="medium-image">
            </div>
            <div class="ui-block-b">
                <ul id="btns-list" style="float:right;">
                    #if ($playdate.getOwner()==$user)
                        <li><a data-ajax="false" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-inline ui-icon-edit ui-btn-icon-notext edit-playdate-link" href="/protected/editplaydate?playdateId=${playdate.id}">Redigera</a></li>
                    #end
                    <li><a href="#" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-inline ui-icon-location ui-btn-icon-notext">location</a></li>
                    #if ($playdate.getOwner()==$user)
                        <li><a href="#popupBasic" data-rel="popup" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-inline ui-icon-user ui-btn-icon-notext" data-transition="pop">adduser</a></li>
                    #end
                </ul>
            </div>
        </div>
        <h2>Datum och tid:</h2>
        <div class="descriptionfield-showplaydate">
            <p><script>
                var timeDateFormat = new Date ($!{playdate.getStartTime()});
                var output = "Den ";
                output += timeDateFormat.getDate()+"/"+(timeDateFormat.getMonth() +1)
                        +" "+timeDateFormat.getFullYear()+" klockan "+timeDateFormat.getHours()+":";
                if (timeDateFormat.getMinutes()<10){
                    output += "0";
                }
                output += timeDateFormat.getMinutes();
                document.write(output);
            </script>
            </p>
        </div>
        <h3>Beskrivning:</h3>
        <div class="descriptionfield-showplaydate">
            <p>$!{playdate.description}</p>
        </div>
        <h3>Deltagare:</h3>

        <h3>Kommentar:</h3>
        <div class="descriptionfield-showplaydate">
            #foreach($!participant in $!playdate.participants)
                <p> <a data-ajax="false" href="/protected/showuser?userId=$!{participant.id}"> $!{participant.getName()}</a> </p>
            #end
        </div>

        <div id="make-comment">
            <form id="makeComment">
                <textarea id="comment" name="comment"></textarea>
                <input type="hidden" id="placeId" name="placeId" value="$!place.id">
                <input type="submit" class="ui-btn" value="Skicka kommentar">
            </form>
        </div>
        <div id="show-comments">
        </div>

        #if ($playdate.getOwner()==$user)
            <a data-playdateid="$!{playdate.id}" style="margin-top: 20%; background: #e33c13 !important; color:white !important;" class="ui-btn ui-corner-all ui-shadow remove-playdate-link" href="#popupValidate" data-rel="popup">Ta bort</a>
        #end

        <div data-role="popup" id="popupBasic">
            <a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
            <p>Här ska man hämta alla vänner och kunna lägga till dem</p>
        </div>



        <div data-role="popup" id="popupValidate" data-overlay-theme="d" data-theme="d" data-dismissible="false" style="max-width:400px;">
                <div role="main" class="ui-content">
                    <h3 class="ui-title">Är du säker på att du vill ta bort Playdaten?</h3>
                    <div id="two-btn-popup">
                    <a href="#" style="width: 5em;" id="popuopNo" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Nej</a>
                    <a href="#" style="width: 5em;" id="popupYes" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Ja</a>
                    </div>
                </div>
        </div>
    </div>







</body>
</html>